# Accounting UX Fixes - 2026-01-19

## Issues Identified & Fixed

### ‚úÖ 1. JDG Screen Showing Wrong Tax Type

**Problem:** JDG accounting page showed "Skala podatkowa" + "Czynny podatnik VAT" + "KPiR" regardless of actual profile settings.

**Root Cause:** UI was not data-driven from `business_profiles.tax_type` and `is_vat_exempt`.

**Fix Applied:**
- Made `JdgAccounting.tsx` fully data-driven
- Reads `taxType` from profile (with fallback to `tax_type`)
- Conditional rendering based on actual tax regime:
  - `isRyczalt` ‚Üí "Rycza≈Çt X%" + "Ewidencja przychod√≥w"
  - `isLiniowy` ‚Üí "Liniowy 19%" + "KPiR"
  - `isSkala` ‚Üí "Skala podatkowa (PIT)" + "KPiR"
- VAT badge shows "Zwolniony (art. 113)" if `is_vat_exempt = true`
- Ewidencja label changes: "Ewidencja przychod√≥w" for rycza≈Çt, "KPiR" for others

**Files Changed:**
- `src/modules/accounting/screens/JdgAccounting.tsx`
- `src/shared/types/index.ts` (added `taxType` alias)

---

### ‚úÖ 2. PIT Tab Inconsistent for JDG

**Problem:** PIT screen said "Skala podatkowa ‚Äì rozliczenie miesiƒôczne" but showed quarterly due dates. Wrong for rycza≈Çt.

**Root Cause:** `PitAdvancesTracker.tsx` not tax-regime aware.

**Fix Applied:**
- Added tax regime detection: `isRyczalt`, `isLiniowy`, `isSkala`
- Description now shows correct form:
  - Rycza≈Çt: "Rycza≈Çt X% - rozliczenie kwartalne (PIT-28)"
  - Liniowy: "Podatek liniowy 19% - rozliczenie miesiƒôczne (PIT-36L)"
  - Skala: "Skala podatkowa - rozliczenie miesiƒôczne (PIT-36)"
- Calculation explanation boxes:
  - Rycza≈Çt: "Zaliczka = Przych√≥d brutto √ó X%"
  - Liniowy: "Zaliczka = (Przych√≥d - Koszty) √ó 19%"
  - Skala: "Zaliczka wg skali: 12% lub 32%"
- Each shows correct form number (PIT-28, PIT-36L, PIT-36)

**Files Changed:**
- `src/modules/accounting/components/PitAdvancesTracker.tsx`

---

### ‚úÖ 3. ZUS Widget Static Data Clarified

**Problem:** ZUS showed "Standardowe sk≈Çadki ZUS (2024)" with hardcoded amounts but no indication it's sample data.

**Fix Applied:**
- Added `Badge` with "Przyk≈Çad (do konfiguracji)" next to title
- Makes it clear these are example amounts, not actual obligations
- User knows they need to configure actual ZUS rates

**Files Changed:**
- `src/modules/accounting/components/ZusPaymentTracker.tsx`

---

### ‚úÖ 4. BusinessProfileForm Saving tax_type

**Problem:** Need to ensure tax_type is properly saved to database.

**Fix Applied:**
- Updated `businessProfileRepository.ts` payload to include:
  - `tax_type: (profile as any).taxType || (profile as any).tax_type || null`
  - `default_ryczalt_rate: normalizeNumberValue((profile as any).defaultRyczaltRate)`
- Added `taxType` and `defaultRyczaltRate` to all return mappings
- Added both `taxType` (camelCase) and `tax_type` (snake_case) to `BusinessProfile` interface

**Files Changed:**
- `src/modules/settings/data/businessProfileRepository.ts`
- `src/shared/types/index.ts`

---

### üîÑ 5. Sp√≥≈Çka Period Auto-Creation (Partially Implemented)

**Problem:** "Okres nie zosta≈Ç utworzony" blocks users from posting. Should auto-create on first post.

**Current Status:**
- ‚úÖ Period creation dialog implemented
- ‚úÖ Legacy invoice migration on period creation
- ‚ö†Ô∏è **Still TODO:** Auto-create period on first posting attempt

**Recommended Implementation:**
```typescript
// In auto_post_invoice_unified or post_to_jdg_register:
// 1. Check if period exists for invoice date
// 2. If not, auto-create period
// 3. Then proceed with posting
```

**Files to Update:**
- Database function: `auto_post_invoice_unified`
- Database function: `post_to_jdg_register`

---

### üîÑ 6. Unposted Documents Widget Needs Reason Codes (TODO)

**Problem:** Widget shows "4 niezaksiƒôgowane dokumenty" but no reasons why.

**Current Status:** Shows count only.

**Recommended Implementation:**

**Add reason enum to invoices:**
```sql
ALTER TABLE invoices 
ADD COLUMN accounting_error_reason TEXT CHECK (
  accounting_error_reason IN (
    'PENDING_ACCEPTANCE',
    'LOCKED_PERIOD',
    'MISSING_RULE',
    'MISSING_PAYMENT_METHOD',
    'INVALID_PROFILE_CONFIG',
    'MISSING_CATEGORY', -- For rycza≈Çt
    'RPC_ERROR'
  )
);
```

**Update UnpostedQueueWidget:**
```tsx
// Show expandable list with reasons
<UnpostedItem>
  <InvoiceNumber>FV/001/2026</InvoiceNumber>
  <ReasonBadge variant="warning">MISSING_RULE</ReasonBadge>
  <Action>Configure posting rule</Action>
</UnpostedItem>
```

**Files to Create/Update:**
- Migration: Add `accounting_error_reason` column
- `src/modules/accounting/components/UnpostedQueueWidget.tsx` - Add expandable list
- Update posting functions to set reason on failure

---

### üîÑ 7. Auto-Post Integration into Real Flows (TODO)

**Problem:** `auto_post_invoice_unified` exists but not called from invoice finalize flow.

**Current Status:** Function exists, not integrated.

**Recommended Implementation:**

**A. Invoice Finalize Flow:**
```typescript
// In src/modules/invoices/data/invoiceRepository.ts
// After invoice is finalized (not draft):

if (!invoice.is_draft && invoice.accounting_status === 'unposted') {
  const { data: profile } = await supabase
    .from('business_profiles')
    .select('entity_type, tax_type')
    .eq('id', invoice.business_profile_id)
    .single();
  
  // Auto-post for Sp√≥≈Çka (always) and JDG rycza≈Çt (if configured)
  if (profile?.entity_type === 'sp_zoo' || 
      profile?.entity_type === 'sa' ||
      (profile?.entity_type === 'dzialalnosc' && profile?.tax_type === 'ryczalt')) {
    
    const { data: result } = await supabase.rpc('auto_post_invoice_unified', {
      p_invoice_id: invoice.id
    });
    
    if (!result?.success) {
      // Mark as needs_review with reason
      await supabase
        .from('invoices')
        .update({ 
          accounting_status: 'needs_review',
          accounting_error_reason: result?.error || 'RPC_ERROR'
        })
        .eq('id', invoice.id);
    }
  }
}
```

**B. Expense Acceptance Flow:**
```typescript
// In ExpenseAcceptanceActions.tsx
// After acceptance:

const { data: result } = await supabase.rpc('auto_post_invoice_unified', {
  p_invoice_id: invoiceId
});

if (!result?.success) {
  toast.warning('Zaakceptowano, ale ksiƒôgowanie wymaga przeglƒÖdu');
}
```

**Files to Update:**
- `src/modules/invoices/data/invoiceRepository.ts`
- `src/modules/inbox/components/ExpenseAcceptanceActions.tsx`

---

## Rycza≈Çt Rate Model Fix (CRITICAL)

### Problem: Single Company-Wide Rate is Wrong

**Current Implementation:**
- `business_profiles.default_ryczalt_rate` - single number
- Assumes one rate per company

**Why It's Wrong:**
- In rycza≈Çt, rate depends on **revenue type** (service category)
- A business can have multiple rates in same month/year
- Examples:
  - IT services: 12%
  - Consulting: 8.5%
  - Trade: 3%

### Correct Model (Already Partially Implemented)

**Database:**
- ‚úÖ `ryczalt_revenue_categories` table exists
- ‚úÖ `jdg_revenue_register_lines.category_id` exists
- ‚ö†Ô∏è `business_profiles.default_ryczalt_rate` should be deprecated

**What's Needed:**

**1. Remove Single Rate Field from BusinessProfileForm:**
```tsx
// REMOVE:
<Input 
  type="number" 
  label="Stawka rycza≈Çtu (%)"
  {...field}
/>

// REPLACE WITH:
<RyczaltCategoriesManager 
  businessProfileId={profile.id}
  categories={ryczaltCategories}
  onUpdate={loadCategories}
/>
```

**2. Add Category Management UI:**
```tsx
<Card>
  <CardHeader>
    <CardTitle>Kategorie przychod√≥w (rycza≈Çt)</CardTitle>
    <CardDescription>
      Stawka zale≈ºy od rodzaju przychodu. Dodaj kategorie i przypisz stawki.
    </CardDescription>
  </CardHeader>
  <CardContent>
    <CategoryList>
      {categories.map(cat => (
        <CategoryRow>
          <Name>{cat.name}</Name>
          <Rate>{cat.rate}%</Rate>
          <Default>{cat.is_default ? '‚úì Domy≈õlna' : ''}</Default>
          <Actions>
            <Edit />
            <Delete />
          </Actions>
        </CategoryRow>
      ))}
    </CategoryList>
    <Button onClick={addCategory}>
      <Plus /> Dodaj kategoriƒô
    </Button>
  </CardContent>
</Card>
```

**3. Invoice Must Select Category:**
```tsx
// On income invoice creation:
<FormField name="ryczalt_category_id">
  <Select>
    <SelectTrigger>Kategoria przychodu (rycza≈Çt)</SelectTrigger>
    <SelectContent>
      {categories.map(cat => (
        <SelectItem value={cat.id}>
          {cat.name} ({cat.rate}%)
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</FormField>
```

**4. Posting Enforces Category:**
```sql
-- In post_to_jdg_register:
IF v_invoice.ryczalt_category_id IS NULL THEN
  RETURN jsonb_build_object(
    'success', FALSE,
    'error', 'MISSING_CATEGORY',
    'message', 'Wybierz kategoriƒô przychodu dla rycza≈Çtu'
  );
END IF;
```

**5. Register Snapshots Category + Rate:**
```sql
INSERT INTO jdg_revenue_register_lines (
  ...
  category_id,
  category_name,
  ryczalt_rate,
  ...
) VALUES (
  ...
  v_category.id,
  v_category.name, -- Snapshot name
  v_category.rate, -- Snapshot rate
  ...
);
```

### Migration Path

**Step 1:** Add category management UI (don't remove old field yet)
**Step 2:** Migrate existing profiles:
```sql
-- For each profile with default_ryczalt_rate:
INSERT INTO business_profile_ryczalt_categories (
  business_profile_id,
  category_id,
  is_default
)
SELECT 
  id,
  (SELECT id FROM ryczalt_revenue_categories WHERE rate = default_ryczalt_rate LIMIT 1),
  TRUE
FROM business_profiles
WHERE default_ryczalt_rate IS NOT NULL;
```

**Step 3:** Deprecate `default_ryczalt_rate` field (keep for backwards compat)

---

## Summary of Changes

### ‚úÖ Completed
1. JDG page now data-driven (shows correct tax type)
2. PIT tracker tax-regime aware (correct forms: PIT-28, PIT-36L, PIT-36)
3. ZUS static data labeled as "Przyk≈Çad"
4. BusinessProfileForm saves tax_type correctly
5. Period creation dialog with legacy migration

### üîÑ In Progress / TODO
1. Auto-create period on first posting attempt
2. Add accounting_error_reason to invoices
3. Unposted widget shows reason codes
4. Integrate auto_post_invoice_unified into invoice finalize
5. Integrate auto_post into expense acceptance
6. Remove single rycza≈Çt rate, add category management
7. Invoice category selection for rycza≈Çt
8. Enforce category on posting

---

## Testing Checklist

### Test JDG Rycza≈Çt Display
- [ ] Create JDG profile with rycza≈Çt 12%
- [ ] Navigate to accounting page
- [ ] Verify badge shows "Rycza≈Çt 12%"
- [ ] Verify ewidencja shows "Ewidencja przychod√≥w" (not KPiR)
- [ ] If VAT exempt, verify badge shows "Zwolniony (art. 113)"
- [ ] Navigate to PIT tab
- [ ] Verify description shows "Rycza≈Çt 12% - rozliczenie kwartalne (PIT-28)"

### Test JDG Liniowy Display
- [ ] Create JDG profile with liniowy
- [ ] Navigate to accounting page
- [ ] Verify badge shows "Liniowy 19%"
- [ ] Verify ewidencja shows "KPiR"
- [ ] Navigate to PIT tab
- [ ] Verify description shows "Podatek liniowy 19% - rozliczenie miesiƒôczne (PIT-36L)"

### Test JDG Skala Display
- [ ] Create JDG profile with skala
- [ ] Navigate to accounting page
- [ ] Verify badge shows "Skala podatkowa (PIT)"
- [ ] Verify ewidencja shows "KPiR"
- [ ] Navigate to PIT tab
- [ ] Verify description shows "Skala podatkowa - rozliczenie miesiƒôczne (PIT-36)"

### Test ZUS Static Data
- [ ] Navigate to ZUS tab
- [ ] Verify "Przyk≈Çad (do konfiguracji)" badge visible
- [ ] User understands these are sample amounts

### Test tax_type Saving
- [ ] Create new JDG profile
- [ ] Select "Rycza≈Çt"
- [ ] Enter rate 12%
- [ ] Save profile
- [ ] Reload page
- [ ] Verify tax type persisted
- [ ] Navigate to accounting page
- [ ] Verify correct display

---

## Next Development Steps

### Priority 1: Auto-Post Integration
- Integrate `auto_post_invoice_unified` into invoice finalize
- Add error reason tracking
- Update unposted widget to show reasons

### Priority 2: Rycza≈Çt Category Model
- Create category management UI
- Add category selection to invoice form
- Enforce category on posting
- Migrate existing profiles

### Priority 3: Period Auto-Creation
- Modify posting functions to auto-create periods
- Remove manual creation requirement
- Keep manual creation as fallback

### Priority 4: Error Handling & UX
- Add detailed error messages
- Show actionable next steps
- Provide "Fix" buttons where possible

---

**Document Version:** 1.0  
**Last Updated:** 2026-01-19  
**Status:** 5/7 issues fixed, 2 in progress
