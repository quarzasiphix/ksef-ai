# Accounting System Bugfixes - 2026-01-19

## Issues Fixed

### 1. ✅ "Auto-księguj wszystkie" 404 Error

**Problem:** 
```
POST /rest/v1/rpc/auto_post_pending_invoices
404 Not Found
Function public.auto_post_pending_invoices not found
```

**Root Cause:** Function didn't exist in database.

**Solution:** Created `auto_post_pending_invoices` function via migration:

```sql
CREATE OR REPLACE FUNCTION auto_post_pending_invoices(
  p_business_profile_id UUID,
  p_limit INTEGER DEFAULT 100
)
RETURNS JSONB
```

**Behavior:**
- Loops through unposted invoices (accounting_status = 'unposted')
- Only processes accepted invoices (acceptance_status IN ('accepted', 'auto_accepted'))
- Calls `auto_post_invoice_unified` for each invoice
- Returns: `{success: true, posted_count: N, failed_count: M, errors: [...]}`
- Limit: 100 invoices per batch (configurable)

**Migration:** `auto_post_pending_invoices_function`

---

### 2. ✅ "Utwórz okres" Button Not Functional

**Problem:** Button in AccountingPeriodStatus component didn't do anything.

**Root Cause:** No click handler, no dialog, no backend function.

**Solution:** 
1. Created `create_accounting_period` function
2. Added period creation dialog with explanation
3. Wired up button to open dialog
4. Dialog shows migration info and creates period

**Features:**
- Dialog explains what will happen
- Shows current month (e.g., "styczeń 2026")
- Warns about legacy invoice migration
- Creates period with status = 'open'
- Migrates legacy invoices automatically

**Migration:** `auto_post_pending_invoices_function` (same migration)

---

### 3. ✅ Backwards Compatibility for Legacy Invoices

**Problem:** Old invoices created before accounting system don't have:
- `acceptance_status` (NULL)
- `accounting_status` (NULL)

**Impact:** These invoices can't be posted, break queries, cause errors.

**Solution:** Created `migrate_legacy_invoices` function:

```sql
CREATE OR REPLACE FUNCTION migrate_legacy_invoices(
  p_business_profile_id UUID
)
RETURNS JSONB
```

**Behavior:**
- Sets `acceptance_status = 'auto_accepted'` for NULL values
- Sets `accounting_status = 'unposted'` for NULL values
- Only updates invoices for specified business profile
- Returns count of updated invoices
- Called automatically when creating period

**Migration:** `auto_post_pending_invoices_function` (same migration)

---

## How It Works Now

### Period Creation Flow

```
User clicks "Utwórz okres" →
Dialog opens with explanation →
User clicks "Utwórz okres" in dialog →

1. Call migrate_legacy_invoices(profile_id)
   - Updates old invoices with default statuses
   - Shows toast: "Zaktualizowano N starszych faktur"

2. Call create_accounting_period(profile_id, year, month)
   - Creates accounting_periods record
   - Status = 'open'
   - Returns period_id

3. Reload current period
4. Show success toast
5. Close dialog
```

### Batch Auto-Posting Flow

```
User clicks "Auto-księguj wszystkie" →

1. Call auto_post_pending_invoices(profile_id, 100)
2. Function loops through unposted invoices:
   - For each invoice: auto_post_invoice_unified(invoice_id)
   - JDG ryczałt → post_to_jdg_register
   - Spółka → auto_post_invoice (journal entries)
3. Returns results:
   - posted_count: Successfully posted
   - failed_count: Failed to post
   - errors: Array of error details
4. Show toast with results
5. Reload unposted queue
```

### Legacy Invoice Migration

**Automatic:** When creating period
**Manual:** Can call `migrate_legacy_invoices` anytime

**What it does:**
```sql
UPDATE invoices
SET 
  acceptance_status = COALESCE(acceptance_status, 'auto_accepted'),
  accounting_status = COALESCE(accounting_status, 'unposted')
WHERE business_profile_id = p_business_profile_id
  AND (acceptance_status IS NULL OR accounting_status IS NULL);
```

**Safe:** Only updates NULL values, doesn't overwrite existing statuses.

---

## Testing Checklist

### Test Period Creation

- [x] Navigate to Spółka accounting page
- [x] Verify "Okres nie został jeszcze utworzony" message
- [x] Click "Utwórz okres" button
- [x] Dialog opens with current month
- [x] Dialog shows migration warning
- [x] Click "Utwórz okres" in dialog
- [x] Toast shows "Zaktualizowano N starszych faktur" (if any)
- [x] Toast shows "Okres księgowy utworzony"
- [x] Period status updates to "Otwarty"

### Test Batch Auto-Posting

- [x] Create 3-5 test invoices (unposted)
- [x] Navigate to Spółka accounting page
- [x] Verify "Niezaksięgowane dokumenty" shows count
- [x] Click "Auto-księguj wszystkie" button
- [x] Wait for processing
- [x] Toast shows "Zaksięgowano N dokumentów"
- [x] Unposted count decreases to 0
- [x] Check ledger - journal entries created

### Test Legacy Invoice Migration

- [x] Create old invoice with NULL statuses
- [x] Create period (triggers migration)
- [x] Verify invoice updated:
  - acceptance_status = 'auto_accepted'
  - accounting_status = 'unposted'
- [x] Verify invoice can now be posted

---

## Database Changes

### New Functions

1. **auto_post_pending_invoices(profile_id, limit)**
   - Batch posts unposted invoices
   - Returns success/failure counts
   - Security: DEFINER (runs as function owner)
   - Grant: authenticated users

2. **create_accounting_period(profile_id, year, month)**
   - Creates accounting period
   - Checks for duplicates
   - Returns period_id
   - Security: DEFINER
   - Grant: authenticated users

3. **migrate_legacy_invoices(profile_id)**
   - Updates NULL statuses
   - Returns updated count
   - Security: DEFINER
   - Grant: authenticated users

### Migration File

**Name:** `auto_post_pending_invoices_function`  
**Applied:** 2026-01-19  
**Status:** ✅ Success

---

## Frontend Changes

### AccountingPeriodStatus.tsx

**Added:**
- `showCreateDialog` state
- `creating` state
- `createPeriod()` function
- Period creation dialog component
- Click handler on "Utwórz okres" button
- Toast notifications
- Legacy migration integration

**Imports:**
- Dialog components
- toast from sonner

---

## Known Limitations

### Period Creation

- Only creates period for current month
- Cannot create periods for past/future months (yet)
- No validation for "already locked" periods

### Batch Auto-Posting

- Limit: 100 invoices per batch
- No progress indicator (processes in background)
- Errors shown in toast (may be truncated if many)

### Legacy Migration

- Only runs when creating period
- No standalone migration UI
- Cannot selectively migrate specific invoices

---

## Future Improvements

### Period Management

- [ ] Create periods for any month
- [ ] Lock/unlock period UI
- [ ] Period summary before locking
- [ ] Validation: "All invoices posted?"

### Batch Posting

- [ ] Progress bar for large batches
- [ ] Detailed error report modal
- [ ] Selective posting (choose which invoices)
- [ ] Dry-run mode (preview without posting)

### Migration

- [ ] Standalone migration button
- [ ] Migration preview (show what will change)
- [ ] Selective migration (by date range)
- [ ] Migration history log

---

## Summary

All reported bugs fixed:
1. ✅ Auto-posting batch function created
2. ✅ Period creation dialog functional
3. ✅ Legacy invoice migration automatic

System is now backwards compatible and production-ready.
