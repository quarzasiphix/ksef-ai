KSeF Integration Status in KsięgaI (Current State)

KSeF integration is listed as a Premium Feature in KsięgaI’s plans – specifically, “Integracja z KSeF: Automatyczne wysyłanie faktur do Krajowego Systemu e-Faktur” (automatic sending of invoices to the National e-Invoice System). In the code and documentation, we can find preparations for KSeF, although full integration is not yet implemented as of now.

Database fields: The invoice table already has fields to track KSeF status and reference. We see an invoice.ksef_status and invoice.ksef_reference_number in the data model. These would store, for example, whether an invoice has been submitted to KSeF and the KSeF’s ID for that invoice (the official reference number assigned by KSeF upon successful submission). In the client code, each Invoice object carries a ksef sub-object with a status (defaulting to 'none' if not yet sent) and a referenceNumber. This means the app is ready to record if an invoice was sent to KSeF and the resulting ID.

Mock KSeF Bypass: Currently, because real KSeF connectivity isn’t in place, the developers implemented a Mock KSeF System for testing. A special document notes that a migration was applied to bypass the KSeF requirement in the event workflow during development. Specifically, the accounting logic originally would block closing an event (posting an invoice to the books) if it was an incoming invoice over 15k PLN without a KSeF reference. This check was temporarily removed to avoid stalling the workflow in development. As a result, right now events are not blocked by missing KSeF data. This is a development convenience so that testing can continue without connecting to the actual government system.

The Mock KSeF doc clearly states that before production, the team must restore the real KSeF checks and implement actual integration. It even provides a checklist: building a KSeF API client, handling authentication, generating the invoice in the required XML format, submitting to KSeF, retrieving the reference number, storing it, error handling, retries, status updates, etc. In the “Current State Summary”, the doc highlights that all normal functionalities work (account selection, event closure, posting) but KSeF is currently bypassed – i.e., “KSeF integration API calls” are not happening and no KSeF reference is required. In short, the app is prepared for KSeF but not yet connected to KSeF in reality.

Code stubs for KSeF: In the repository, there is a module src/integrations/ksef/ksefGenerator.ts which contains placeholder functions to build a KSeF-compliant XML invoice. It defines interfaces corresponding to the KSeF FA (Faktura) structure (e.g. KsefHeader, KsefSeller as Podmiot1, KsefBuyer as Podmiot2, etc.) and a function generateKsefData(invoice, businessProfile, customer) that maps KsięgaI’s internal Invoice object to a KsefInvoice structure. For example, it maps the seller’s NIP and address, buyer’s name and address, each invoice item’s details (quantity, price, VAT rate), and totals into the proper KSeF fields (like P_7 for quantity, P_13 for total net, etc.). This function is currently a basic implementation (lots of TODO comments to refine mapping once the official schema is confirmed).

There’s also generateKsefXml(ksefData) which uses an XML builder library to construct the XML document from that data structure. It inserts the required XML namespaces and elements according to the FA(3) schema (the code has placeholder namespaces and element names as of now). It covers sections like <Nagłówek> (header), <Podmiot1> (seller), <Podmiot2> (buyer), <FaWiersz> items, and <Podsumowanie> totals. This stub shows that the team is aware of the FA(3) structured invoice format and is gearing up to produce it. The final part of that file even notes a // TODO: Add functions for interacting with KSeF API (sending, checking status, etc.), which underscores that the actual submission and retrieval logic is the next step.

Supabase Edge Functions: On the backend side, there are Supabase edge functions prepared for KSeF. One is submit-ksef – presumably called when an invoice needs to be sent. This function currently simulates sending: it takes an invoiceId, fetches the invoice (expecting a signed XML attached), and instead of really calling KSeF, it fakes a response (generating a dummy reference like REF-<invoiceId> and a dummy UPO confirmation). It then updates the invoice record in the database with ksef_status = "submitted", the ksef_reference (reference number), and stores the dummy UPO text. This tells us a few things: (1) There is a plan to store the UPO (official acknowledgment) for each invoice (likely in a field like ksef_upo), and (2) the status might have states like "submitted", "error", etc., to show if the invoice is sent. Another function start-pz-sign and pz-callback appear related to the signing process (possibly integration with an external signing service PZ – “Podpis Zaufany” or e-signature). It’s likely the workflow is: generate XML -> sign it with a certificate -> then call submit-ksef to send it. These pieces are in place but not fully wired up yet.

In summary, the current state of KSeF in KsięgaI: the app has the hooks and placeholders ready – database fields to record KSeF info, code to construct the proper XML, and server functions to handle submission. However, the actual connection to KSeF’s API and the real-time exchange is not done yet (it’s on the roadmap). The development team has temporarily disabled any hard dependency on KSeF to allow using the app normally until integration is completed. Now, to proceed, we should understand how KSeF itself works and what needs to happen to connect KsięgaI with KSeF.